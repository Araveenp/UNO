<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>UNO Online — Fixed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--glass: rgba(255,255,255,0.06);} body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial; background: radial-gradient(circle at 10% 10%, #0f172a, #020617 60%); color:#fff; margin:0; height:100vh;}

    /* Layout */
    .center-screen{height:100vh;display:flex;align-items:center;justify-content:center;}
    .card-ui{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));border-radius:14px;padding:24px;box-shadow:0 6px 30px rgba(2,6,23,0.7);backdrop-filter: blur(6px);}

    /* Buttons & effects */
    .glow-btn{transition:transform .18s ease, box-shadow .18s ease;border-radius:10px;padding:.6rem 1rem;font-weight:600}
    .glow-btn:hover{transform:translateY(-3px);box-shadow:0 8px 30px rgba(99,102,241,0.18)}

    /* small helpers */
    .hidden{display:none}
    #playerList li{margin:6px 0;padding:8px;border-radius:8px;background:var(--glass);}

    /* simple fade/slide animations */
    .fade-in{animation:fadeIn .5s ease both}
    @keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

    /* card placeholders */
    .card-spot{width:72px;height:108px;border-radius:8px;background:linear-gradient(180deg,#111827,#0b1220);box-shadow:inset 0 -2px 6px rgba(0,0,0,0.5);}
  </style>
</head>
<body>
  <div id="app" class="center-screen">
    <div class="card-ui w-[980px] max-w-[95%] fade-in">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-4xl font-extrabold text-yellow-300">UNO Online</h1>
        <div id="statusText" class="text-sm text-gray-300">Connecting...</div>
      </div>

      <div id="lobbyScreen">
        <div class="flex gap-4 items-center mb-4">
          <button id="createGame" class="glow-btn bg-green-500 hover:bg-green-600">Create Game</button>
          <div class="flex items-center gap-2">
            <input id="gameCode" class="px-3 py-2 rounded-md text-black" placeholder="Enter Game ID (ABCD)" />
            <button id="joinGame" class="glow-btn bg-blue-500 hover:bg-blue-600">Join</button>
          </div>
          <button id="startGame" class="glow-btn bg-yellow-400 text-black hidden">Start Game</button>
        </div>

        <div class="flex gap-6">
          <div style="flex:1">
            <div class="text-sm text-gray-300 mb-2">Players in Lobby</div>
            <ul id="playerList"></ul>
          </div>
          <div style="width:280px">
            <div class="text-sm text-gray-300 mb-2">Game Info</div>
            <div id="lobbyInfo" class="p-3 rounded-md" style="background:rgba(255,255,255,0.02)">Waiting...</div>
          </div>
        </div>
      </div>

      <div id="gameScreen" class="hidden mt-6">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <div class="card-spot" id="discardPile"></div>
            <div class="text-sm">Discard</div>
          </div>
          <div>
            <div class="text-sm text-gray-300">Your Hand</div>
            <div id="playerHand" class="mt-2 flex gap-2 flex-wrap"></div>
          </div>
          <div>
            <button id="backToLobby" class="glow-btn bg-red-600 hover:bg-red-700">Exit to Lobby</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    /* --------------------------------------------------------------------------
       Fixed UNO lobby: ensure auth ready before accessing currentUser.uid.
       - Buttons disabled until auth completes
       - Guard all functions that need currentUser
       - Provide clear UI status text
       -------------------------------------------------------------------------- */

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIPxkUrfyMSzdddaBHHQ7hrhTMbTlOvao",
      authDomain: "uno-game-3e82a.firebaseapp.com",
      projectId: "uno-game-3e82a",
      storageBucket: "uno-game-3e82a.firebasestorage.app",
      messagingSenderId: "40853251329",
      appId: "1:40853251329:web:c57964dcf70b8d3f4fe700"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elements
    const createBtn = document.getElementById('createGame');
    const joinBtn = document.getElementById('joinGame');
    const startBtn = document.getElementById('startGame');
    const backBtn = document.getElementById('backToLobby');
    const lobbyInfo = document.getElementById('lobbyInfo');
    const statusText = document.getElementById('statusText');
    const playerListEl = document.getElementById('playerList');
    const gameCodeInput = document.getElementById('gameCode');
    const playerHandEl = document.getElementById('playerHand');
    const discardPileEl = document.getElementById('discardPile');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameScreen = document.getElementById('gameScreen');

    // State
    let currentUser = null; // will be set only after auth ready
    let currentGameId = null;
    let unsubscribe = null;

    // Utility: disable/enable main controls while auth isn't ready
    function setControlsEnabled(enabled) {
      createBtn.disabled = !enabled;
      joinBtn.disabled = !enabled;
      startBtn.disabled = !enabled;
      createBtn.style.opacity = enabled ? '1' : '0.6';
      joinBtn.style.opacity = enabled ? '1' : '0.6';
      startBtn.style.opacity = enabled ? '1' : '0.6';
    }

    // Initially disable controls until auth finishes
    setControlsEnabled(false);
    statusText.textContent = 'Connecting...';

    // Ensure we are signed in. If not signed in, sign in anonymously.
    // Use onAuthStateChanged to know when a user object is available.
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        try {
          // This will trigger another onAuthStateChanged call when complete
          await signInAnonymously(auth);
          statusText.textContent = 'Signing in...';
          return;
        } catch (err) {
          console.error('Anonymous sign-in failed:', err);
          statusText.textContent = 'Auth failed';
          return;
        }
      }

      // At this point we have a user
      currentUser = user;
      console.log('Authenticated as', currentUser.uid);
      statusText.textContent = 'Connected';
      setControlsEnabled(true);
      lobbyInfo.textContent = 'You are connected. Create or join a game.';

      // If user was already in a game (left page open), we could re-subscribe here.
    });

    // Helper to reference game documents
    function getGameRef(id) {
      return doc(collection(db, 'unoGames'), id);
    }

    // Helper to show a small message
    function showLobbyMessage(msg) {
      lobbyInfo.textContent = msg;
    }

    // Guard: ensure auth is ready before calling functions that use currentUser.uid
    function requireAuthOrWarn() {
      if (!currentUser) {
        showLobbyMessage('Still signing in... please wait a moment.');
        return false;
      }
      return true;
    }

    // Create game: ensure currentUser exists
    createBtn.addEventListener('click', async () => {
      if (!requireAuthOrWarn()) return;

      // Disable while creating
      setControlsEnabled(false);
      showLobbyMessage('Creating game...');

      const id = Math.random().toString(36).substring(2, 6).toUpperCase();
      const ref = getGameRef(id);

      try {
        await setDoc(ref, { players: [currentUser.uid], status: 'waiting', createdAt: Date.now() });
        currentGameId = id;
        subscribeToGame(id);
        showLobbyMessage(`Game created — ID: ${id}. Waiting for players...`);
      } catch (err) {
        console.error('Create game failed:', err);
        showLobbyMessage('Failed to create game. Try again.');
        setControlsEnabled(true);
      }
    });

    // Join game
    joinBtn.addEventListener('click', async () => {
      if (!requireAuthOrWarn()) return;
      const id = (gameCodeInput.value || '').trim().toUpperCase();
      if (!id) { showLobbyMessage('Enter a valid Game ID.'); return; }

      setControlsEnabled(false);
      showLobbyMessage(`Joining ${id}...`);

      const ref = getGameRef(id);
      try {
        await runTransaction(db, async (tx) => {
          const docSnap = await tx.get(ref);
          if (!docSnap.exists()) throw new Error('Game not found');
          const data = docSnap.data();
          const players = Array.isArray(data.players) ? [...data.players] : [];
          if (players.includes(currentUser.uid)) return; // already joined
          if (players.length >= 6) throw new Error('Game full');
          players.push(currentUser.uid);
          tx.update(ref, { players });
        });

        currentGameId = id;
        subscribeToGame(id);
        showLobbyMessage(`Joined ${id}. Waiting for host.`);
      } catch (err) {
        console.error('Join failed:', err);
        showLobbyMessage(err.message || 'Failed to join.');
        setControlsEnabled(true);
      }
    });

    // Subscribe to game updates and render lobby / start visibility
    function subscribeToGame(id) {
      if (unsubscribe) unsubscribe();
      const ref = getGameRef(id);

      unsubscribe = onSnapshot(ref, (snap) => {
        if (!snap.exists()) {
          showLobbyMessage('Game was removed or not found.');
          setControlsEnabled(true);
          return;
        }

        const data = snap.data();
        // Render players
        playerListEl.innerHTML = '';
        const players = Array.isArray(data.players) ? data.players : [];
        players.forEach((p, i) => {
          const li = document.createElement('li');
          const isYou = currentUser && p === currentUser.uid;
          li.textContent = `Player ${i + 1}` + (isYou ? ' (You)' : '');
          playerListEl.appendChild(li);
        });

        // Show / hide start button only for host and when waiting
        const isHost = currentUser && players[0] === currentUser.uid;
        const enough = players.length >= 2;
        if (isHost && enough && data.status === 'waiting') {
          startBtn.classList.remove('hidden');
        } else {
          startBtn.classList.add('hidden');
        }

        // Show lobby / game screen
        if (data.status === 'active') {
          lobbyScreen.classList.add('hidden');
          gameScreen.classList.remove('hidden');
          // simple placeholder UI: show basic player hand & top card
          renderGameState(data);
        } else {
          lobbyScreen.classList.remove('hidden');
          gameScreen.classList.add('hidden');
        }

        // Update lobby info
        document.getElementById('lobbyInfo').textContent = `Game ID: ${id} — Players: ${players.length}`;
      }, (err) => {
        console.error('Subscribe error:', err);
        showLobbyMessage('Connection lost.');
        setControlsEnabled(true);
      });
    }

    // Start game (only host should be able to click) — guard again
    startBtn.addEventListener('click', async () => {
      if (!requireAuthOrWarn()) return;
      if (!currentGameId) { showLobbyMessage('No game selected.'); return; }

      const ref = getGameRef(currentGameId);
      try {
        await updateDoc(ref, { status: 'active', startedAt: Date.now() });
        // UI will switch when snapshot updates
      } catch (err) {
        console.error('Start failed:', err);
        showLobbyMessage('Failed to start game.');
      }
    });

    // Back to lobby
    backBtn.addEventListener('click', () => {
      if (unsubscribe) unsubscribe();
      currentGameId = null;
      playerListEl.innerHTML = '';
      lobbyScreen.classList.remove('hidden');
      gameScreen.classList.add('hidden');
      setControlsEnabled(true);
    });

    // Render a very small placeholder game state so the UI is not empty after starting
    function renderGameState(gameData) {
      // Clear
      playerHandEl.innerHTML = '';
      discardPileEl.innerHTML = '';

      // Show a fake top card (use chosen color/value if you add real game mechanics later)
      const top = document.createElement('div');
      top.className = 'card-spot';
      top.title = 'Top of discard pile';
      discardPileEl.appendChild(top);

      // Show small placeholders for the player's hand (7 cards)
      for (let i = 0; i < 7; i++) {
        const c = document.createElement('div');
        c.className = 'card-spot';
        c.style.width = (60 + (i % 3) * 4) + 'px';
        c.style.height = '88px';
        playerHandEl.appendChild(c);
      }
    }

    // On unload, clean up listeners
    window.addEventListener('beforeunload', () => {
      if (unsubscribe) unsubscribe();
    });

  </script>
</body>
</html>
