<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online UNO Game</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            overflow: hidden;
        }

        #lobby-screen {
            background-color: #1a202c;
            background-image: radial-gradient(circle, #2d3748 0%, #1a202c 100%);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            padding: 20px;
        }

        #game-screen {
            background-color: #054b23;
            background: radial-gradient(circle, #0a8f44 0%, #043a1b 100%);
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
        }

        .card {
            width: 80px;
            height: 120px;
            border-radius: 8px;
            background-color: #1a202c;
            border: 2px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            cursor: pointer;
        }
        
        .card.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .card.red { background-color: #EF4444; }
        .card.yellow { background-color: #F59E0B; }
        .card.green { background-color: #10B981; }
        .card.blue { background-color: #3B82F6; }
        .card.wild { background-color: #1F2937; }

        .color-swatch {
            width: 100%;
            height: 100%;
            border-radius: 6px;
            opacity: 0.8;
        }

        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            color: #1F2937;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            z-index: 100;
            text-align: center;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="text-white font-sans">

    <div id="lobby-screen">
        <div class="w-full max-w-md text-center mx-auto relative z-10">
            <h1 class="text-6xl font-extrabold mb-8 text-white" style="filter: drop-shadow(0 0 10px rgba(255, 255, 0, 0.5));">
                Online UNO
            </h1>
            
            <div class="space-y-6">
                <button id="create-game-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 rounded-lg text-xl transition duration-200 transform hover:scale-105 shadow-lg">
                    Create New Game
                </button>
                <div class="relative flex items-center">
                    <hr class="w-full border-gray-400">
                    <span class="absolute left-1/2 -translate-x-1/2 bg-gray-700 px-4 text-gray-200">OR</span>
                </div>
                <input type="text" id="game-id-input" placeholder="Enter Game ID" class="w-full p-4 rounded-lg text-black text-center text-lg">
                <button id="join-game-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg text-xl transition duration-200 transform hover:scale-105 shadow-lg">
                    Join Game
                </button>
            </div>
            <div id="lobby-info" class="mt-8 text-lg font-semibold"></div>

            <div id="lobby-players-container" class="hidden mt-6 w-full">
                <h3 class="text-xl font-semibold mb-2">Players in Lobby:</h3>
                <ul id="lobby-player-list" class="list-none bg-black bg-opacity-20 rounded-lg p-4 text-left min-h-[50px]"></ul>
            </div>

            <div class="mt-6 w-full">
                <button id="start-game-btn" class="hidden w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-4 px-6 rounded-lg text-xl transition duration-200 transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                    Start Game
                </button>
            </div>
        </div>
    </div>

    <div id="game-screen" class="hidden">
        <div class="w-full pt-4">
            <h2 class="text-center text-xl font-bold mb-2">Opponents' Hands</h2>
            <div id="opponent-hands" class="flex justify-center flex-wrap gap-4 p-4 min-h-[100px]"></div>
        </div>

        <div class="flex-grow flex items-center justify-around w-full max-w-6xl mx-auto px-4">
            <div class="w-1/3 max-w-xs bg-black bg-opacity-30 p-4 rounded-lg shadow-lg">
                <h3 class="text-center text-lg font-bold mb-3">Player Order</h3>
                <ol id="player-list" class="flex flex-col space-y-2"></ol>
            </div>

            <div class="flex items-center justify-center space-x-8">
                <div>
                    <div id="draw-pile" class="card">UNO</div>
                    <p class="text-center mt-2 font-semibold">Draw Pile</p>
                </div>
                <div>
                    <div id="discard-pile" class="card"></div>
                    <p class="text-center mt-2 font-semibold">Discard Pile</p>
                </div>
            </div>

            <div class="w-1/3 max-w-xs">
                <button id="leave-game-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg">
                    Leave Game
                </button>
            </div>
        </div>

        <div class="w-full">
            <h2 class="text-center text-xl font-bold mt-2">Your Hand</h2>
            <div id="player-hand" class="flex justify-center flex-wrap gap-2 p-4 min-h-[140px]"></div>
        </div>
    </div>

    <div id="message-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, runTransaction, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const lobbyScreen = document.getElementById('lobby-screen');
        const gameScreen = document.getElementById('game-screen');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameBtn = document.getElementById('join-game-btn');
        const gameIdInput = document.getElementById('game-id-input');
        const startGameBtn = document.getElementById('start-game-btn');
        const leaveGameBtn = document.getElementById('leave-game-btn');
        const lobbyInfo = document.getElementById('lobby-info');
        const lobbyPlayersContainer = document.getElementById('lobby-players-container');
        const lobbyPlayerList = document.getElementById('lobby-player-list');
        const playerHandEl = document.getElementById('player-hand');
        const opponentHandsEl = document.getElementById('opponent-hands');
        const playerListEl = document.getElementById('player-list');
        const discardPileEl = document.getElementById('discard-pile');
        const drawPileEl = document.getElementById('draw-pile');
        const messageContainer = document.getElementById('message-container');

        const firebaseConfig = {
          apiKey: "AIzaSyDIPxkUrfyMSzdddaBHHQ7hrhTMbTlOvao",
          authDomain: "uno-game-3e82a.firebaseapp.com",
          projectId: "uno-game-3e82a",
          storageBucket: "uno-game-3e82a.firebasestorage.app",
          messagingSenderId: "40853251329",
          appId: "1:40853251329:web:c57964dcf70b8d3f4fe700",
          measurementId: "G-MBZTN7G8MC"
        };

        let app, auth, db;
        let currentUserId = null;
        let currentGameId = null;
        let unsubscribeFromGame = null;

        const COLORS = ['Red', 'Yellow', 'Green', 'Blue'];
        const VALUES = ['0','1','2','3','4','5','6','7','8','9','Skip','Reverse','Draw Two'];
        const WILD_VALUES = ['Wild','Wild Draw Four'];

        async function init() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            setLogLevel('debug');
            auth = getAuth(app);
            onAuthStateChanged(auth, async (user) => {
                if (user) currentUserId = user.uid;
                else await signInAnonymously(auth);
            });
            createGameBtn.onclick = createGame;
            joinGameBtn.onclick = joinGame;
            startGameBtn.onclick = startGame;
            leaveGameBtn.onclick = returnToLobby;
            renderUI(null);
        }

        function showMessage(text, duration = 4000) {
            messageContainer.innerHTML = ''; 
            const msgBox = document.createElement('div');
            msgBox.className = 'message-box';
            msgBox.textContent = text;
            messageContainer.appendChild(msgBox);
            setTimeout(() => msgBox.remove(), duration);
        }

        function getGameCollectionRef() {
            return collection(db, "unoGames");
        }

        function renderUI(gameData) {
            if (!gameData) {
                lobbyScreen.classList.remove('hidden');
                gameScreen.classList.add('hidden');
                lobbyPlayersContainer.classList.add('hidden');
                startGameBtn.classList.add('hidden');
                return;
            }

            if (gameData.status === 'waiting') {
                lobbyScreen.classList.remove('hidden');
                gameScreen.classList.add('hidden');
                lobbyPlayersContainer.classList.remove('hidden');
                lobbyPlayerList.innerHTML = '';
                gameData.players.forEach((playerId, i) => {
                    const li = document.createElement('li');
                    li.textContent = `Player ${i+1}${playerId===currentUserId?" (You)":""}${playerId===gameData.hostId?" (Host)":""}`;
                    lobbyPlayerList.appendChild(li);
                });
                if (currentUserId === gameData.hostId) {
                    startGameBtn.classList.remove('hidden');
                    startGameBtn.disabled = gameData.players.length < 2;
                } else startGameBtn.classList.add('hidden');
            }
            else if (gameData.status === 'active') {
                lobbyScreen.classList.add('hidden');
                gameScreen.classList.remove('hidden');
            }
        }

        function createCardElement(card, isFaceDown=false) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card';
            if (isFaceDown) cardEl.textContent = 'UNO';
            else {
                cardEl.classList.add(card.color.toLowerCase());
                let value = card.value;
                if (value === 'Draw Two') value = '+2';
                if (value === 'Wild Draw Four') value = '+4';
                if (value === 'Wild') value = 'W';
                if (value === 'Skip') value = 'S';
                if (value === 'Reverse') value = 'R';
                cardEl.textContent = value;
            }
            return cardEl;
        }

        async function attachGameListener(gameId) {
            currentGameId = gameId;
            const gameRef = doc(getGameCollectionRef(), gameId);
            if (unsubscribeFromGame) unsubscribeFromGame();
            unsubscribeFromGame = onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return returnToLobby();
                renderUI(doc.data());
            });
        }

        async function createGame() {
            const gameId = Math.random().toString(36).substring(2,7).toUpperCase();
            const gameRef = doc(getGameCollectionRef(), gameId);
            await setDoc(gameRef, {
                gameId, status:'waiting', players:[currentUserId], hostId:currentUserId, gameLog:[]
            });
            attachGameListener(gameId);
        }

        async function joinGame() {
            const gameId = gameIdInput.value.trim().toUpperCase();
            const gameRef = doc(getGameCollectionRef(), gameId);
            const docSnap = await getDoc(gameRef);
            if (!docSnap.exists()) return showMessage("Game not found.");
            const data = docSnap.data();
            if (data.status!=='waiting') return showMessage("Game already started.");
            if (!data.players.includes(currentUserId))
                await runTransaction(db, async (tr)=>{
                    const gameDoc=await tr.get(gameRef);
                    const d=gameDoc.data();
                    tr.update(gameRef,{players:[...d.players,currentUserId]});
                });
            attachGameListener(gameId);
        }

        async function startGame() {
            startGameBtn.disabled = true;
            if (!currentGameId) return showMessage("No game ID.");
            const gameRef = doc(getGameCollectionRef(), currentGameId);
            const freshDoc = await getDoc(gameRef);
            if (!freshDoc.exists()) return showMessage("Game not found.");
            const freshData = freshDoc.data();
            await runTransaction(db, async (tr)=>{
                const newDeck=createAndShuffleDeck();
                const playerHands={};
                freshData.players.forEach(uid=>playerHands[uid]=newDeck.splice(0,7));
                let firstCard=newDeck.pop();
                tr.update(gameRef,{
                    status:"active",
                    deck:newDeck,
                    playerHands,
                    discardPile:[firstCard],
                    chosenColor:firstCard.color,
                    currentPlayerUid:freshData.players[0],
                    turnDirection:1
                });
            });

            âœ… // Immediate UI update to open playground
            renderUI({status:"active"}); 
        }

        function returnToLobby() {
            if (unsubscribeFromGame) unsubscribeFromGame();
            renderUI(null);
        }

        function createAndShuffleDeck() {
            let deck=[];
            for (const color of COLORS) {
                deck.push({color,value:'0'});
                for (let i=1;i<=9;i++){
                    deck.push({color,value:i.toString()});
                    deck.push({color,value:i.toString()});
                }
                for (const v of ['Skip','Reverse','Draw Two']) {
                    deck.push({color,value:v});
                    deck.push({color,value:v});
                }
            }
            for (const v of WILD_VALUES)
                for (let i=0;i<4;i++) deck.push({color:'Wild',value:v});
            for (let i=deck.length-1;i>0;i--){
                const j=Math.floor(Math.random()*(i+1));
                [deck[i],deck[j]]=[deck[j],deck[i]];
            }
            return deck;
        }

        init();
    </script>
</body>
</html>
